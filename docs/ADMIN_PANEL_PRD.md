# DMPool 管理后台产品需求文档 (PRD)

**版本**: v1.0
**日期**: 2026-02-03
**目标用户**: 中型专业比特币矿池运营商

---

## 一、用户角色分析

### 1.1 矿池所有者 (Pool Owner)

**核心需求**:
- 随时了解矿池整体运营状况
- 查看收益数据和支付状态
- 管理矿工和地址白名单
- 配置矿池参数

**典型场景**:
- 每日查看昨日收益、区块数
- 查看算力趋势和矿工活跃度
- 处理异常情况（如算力骤降）
- 调整费率、难度等参数

### 1.2 运维人员 (Ops Admin)

**核心需求**:
- 监控系统健康状态
- 查看实时日志和告警
- 管理配置和部署
- 处理技术问题

**典型场景**:
- 监控服务器资源使用率
- 查看连接数、份额统计
- 处理节点同步问题
- 执行备份恢复

### 1.3 矿工 (Miner)

**核心需求**:
- 查看个人算力和收益
- 查看 Worker 状态
- 查看支付记录
- 获取挖矿统计

**典型场景**:
- 查看今日算力
- 查看历史收益
- 检查 Worker 是否正常
- 查看未支付余额

---

## 二、功能模块设计

### 2.1 核心功能 (MVP - 第一阶段)

#### A. 仪表盘 (Dashboard)

**位置**: 首页

**内容**:
```
┌─────────────────────────────────────────────────────────────┐
│  DMPool 管理后台                         状态: ● 运行中    │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 总算力      │  │ 24h收益     │  │ 在线矿工    │        │
│  │ 125.5 TH/s │  │ 0.0125 BTC  │  │ 1,234       │        │
│  │ +5.2% ↗    │  │            │  │ +12 ↗      │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 已挖区块    │  │ PPLNS窗口   │  │ 份额/秒     │        │
│  │ 1,234       │  │ 7天         │  │ 1,234/s     │        │
│  │            │  │ 89.2M shares │  │            │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                               │
│  [实时算力图表 - 24h]  [收益趋势 - 7d]                   │
└─────────────────────────────────────────────────────────────┘
```

#### B. 配置管理 (Configuration)

**位置**: 设置 → 配置

**核心配置项**:

| 分类 | 参数 | 说明 | 修改方式 |
|-----|------|------|---------|
| **Stratum** | 端口、监听地址 | 矿机连接 | 热更新 |
| | 初始难度 | 新矿工起始难度 | 热更新 |
| | 最低难度 | 最低挖矿难度 | 热更新 |
| **PPLNS** | TTL天数 | 份额有效期 | 需重启 |
| | 难度倍数 | 窗口大小 | 需重启 |
| **收益** | 捐赠比例 | 开发者捐赠 | 需重启 |
| | 矿池费率 | 运营商收益 | 需重启 |
| **安全** | ignore_difficulty | ⚠️ 关键参数 | 需重启 |
| **限制** | 连接数限制 | 防DDoS | 热更新 |
| | 速率限制 | API限流 | 热更新 |

**关键参数警告设计**:
```
┌──────────────────────────────────────────────────────────┐
│ ⚠️ 关键参数状态                                          │
├──────────────────────────────────────────────────────────┤
│                                                            │
│  ignore_difficulty:  ❌ 已禁用                           │
│  └─ 当前状态可能导致不公平的PPLNS计算                      │
│  └─ 建议: 设置为 false                                    │
│                                                            │
│  pplns_ttl_days:   ❌ 1天 (太短!)                       │
│  └─ 标准为7天, 当前设置会导致矿工损失~85%收益                │
│  └─ 建议: 设置为 7                                        │
│                                                            │
│  donation:          ✅ 0%                                │
│  └─ 当前未设置捐赠, 矿工获得100%收益                       │
│                                                            │
└──────────────────────────────────────────────────────────┘
```

#### C. 矿工管理 (Workers)

**位置**: 矿工列表

**功能**:
- 查看所有在线矿工
- 按地址、Worker名搜索
- 查看矿工详细统计
- 封禁/解封矿工
- 查看矿工收益记录

**列表视图**:
```
┌─────────────────────────────────────────────────────────────┐
│ 🔍 搜索: [地址/Worker名过滤...]      [封禁列表] [导出]       │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  地址                          Worker  算力    份额   状态    操作│
│  ───────────────────────────────────────────────────────────│
│  bc1q...a1b2                    worker1  5.2    12.3K  正常   详情│
│  bc1q...c3d4                    worker2  3.1    8.5K   正常   详情│
│  bc1q...e5f6                    rig01    8.8    25.1K  正常   详情│
│  bc1q...g7h8                    farm01   102.4  156K   正常   详情│
│  bc1q...i9j0                    unknown  0.0    0      离线   详情│
│  bc1q...k1l2                    stratum  0.0    12     ⚠️异常  详情│
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

#### D. 区块与收益 (Blocks & Payouts)

**位置**: 区块记录

**已挖区块列表**:
```
┌─────────────────────────────────────────────────────────────┐
│  区块高度    时间          交易哈希            状态         │
│  ───────────────────────────────────────────────────────────│
│  823456     10分钟前     0xabc123...         已确认 (12/12) │
│  823455     2小时前      0xdef456...         已确认 (6/6)   │
│  823454     5小时前      0x789abc...         已确认 (18/18)  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**点击区块查看收益分配**:
```
区块 #823456 - 0xabc123...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
总奖励: 6.25 BTC (区块奖励) + 0.12 BTC (交易费) = 6.37 BTC

收益分配:
  bc1q...a1b2 (worker1)    1.254 BTC  (19.7%)
  bc1q...c3d4 (worker2)    0.856 BTC  (13.4%)
  bc1q...e5f6 (rig01)      2.412 BTC  (37.9%)
  ... (其他矿工)

Coinbase交易: [查看] [在浏览器打开]
```

---

### 2.2 高级功能 (第二阶段)

#### E. 实时监控 (Monitoring)

**位置**: 监控

**内容**:
- 服务器资源使用 (CPU/内存/磁盘/网络)
- Stratum 连接数统计
- 份额提交速率
- 份额拒绝率统计
- RPC 响应时间
- ZMQ 连接状态

#### F. 日志管理 (Logs)

**位置**: 日志

**功能**:
- 实时日志流
- 日志搜索和过滤
- 日志级别切换
- 日志导出

#### G. 备份与恢复 (Backup)

**位置**: 数据管理

**功能**:
- 查看备份历史
- 手动创建备份
- 恢复备份
- 验证备份完整性

---

### 2.3 矿工端功能 (第三阶段)

#### H. 矿工个人中心

**访问**: `https://pool.dmpool.org/miner/{address}`

**内容**:
- 个人算力统计 (24h/7d/30d)
- Worker 列表和状态
- 未支付余额估算
- 支付历史记录
- PPLNS 份额明细

---

## 三、用户体验设计

### 3.1 导航结构

```
┌─────────────────────────────────────────────────────────────┐
│  [DMPool]             [仪表盘] [配置] [矿工] [区块] [监控]    │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 响应式设计

- **桌面端** (>1024px): 完整功能，侧边导航
- **平板端** (768-1024px): 简化布局，顶部导航
- **手机端** (<768px): 移动优化，卡片式布局

### 3.3 深色模式 (默认)

- 适合长时间监控
- 减少眼疲劳
- 专业矿池风格

---

## 四、技术架构

### 4.1 技术栈

**前端**:
```
- 框架: 无框架 (Vanilla JS + HTML5)
- 样式: TailwindCSS (通过 CDN)
- 图表: Chart.js (通过 CDN)
- 构建: 无需构建，直接部署
```

**后端**:
```
- 语言: Rust
- 框架: Axum (已依赖)
- 认证: HTTP Basic Auth (复用现有)
- 数据源: DMPool API + 数据库直接读取
```

### 4.2 部署架构

```
                    ┌─────────────────┐
                    │   Nginx/Caddy   │
                    │   (反向代理)     │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
         ┌────▼────┐   ┌─────▼─────┐   ┌──▼────────┐
         │ DMPool  │   │ DMPool    │   │  Grafana   │
         │  API    │   │  Admin    │   │           │
         │ (46884) │   │  (8080)   │   │  (3000)    │
         └─────────┘   └───────────┘   └────────────┘
              │              │
         ┌────▼────┐   ┌─────▼─────┐
         │ Stratum │   │ Database  │
         │ (3333)  │   │ (RocksDB) │
         └─────────┘   └───────────┘
```

### 4.3 API 设计

**REST API 端点**:

```
GET  /api/health              # 健康检查
GET  /api/dashboard          # 仪表盘数据
GET  /api/config             # 获取配置
POST /api/config             # 更新配置(部分)
GET  /api/workers            # 矿工列表
GET  /api/workers/{address}  # 矿工详情
POST /api/workers/{id}/ban   # 封禁矿工
GET  /api/blocks             # 区块列表
GET  /api/blocks/{id}        # 区块详情
GET  /api/payouts            # 支付记录
GET  /api/logs               # 日志流
GET  /api/stats              # 统计数据
```

---

## 五、开发计划

### Phase 1: MVP (1-2周)

**目标**: 基础管理功能

- [x] 项目结构搭建
- [ ] 仪表盘 (实时算力、收益、矿工数)
- [ ] 配置查看和警告
- [ ] 矿工列表 (基础)
- [ ] 简单认证
- [ ] 基础API端点

**验收标准**:
- 可以查看矿池运行状态
- 可以查看关键配置
- 可以查看矿工列表
- 有基本的认证保护

### Phase 2: 核心功能 (2-3周)

**目标**: 完整管理能力

- [ ] 配置热更新
- [ ] 矿工详情页
- [ ] 矿工封禁/解封
- [ ] 区块记录和详情
- [ ] 收益分配查看
- [ ] 实时日志查看器
- [ ] 数据导出功能

**验收标准**:
- 可以动态调整部分配置
- 可以管理矿工
- 可以查看完整的区块和收益数据
- 有完整的日志查看功能

### Phase 3: 高级功能 (3-4周)

**目标**: 专业级管理

- [ ] 实时监控面板
- [ ] 告警系统配置
- [ ] 备份管理界面
- [ ] 矿工个人中心 (公开)
- [ ] 多语言支持
- [ ] 移动端优化

**验收标准**:
- 有完整的监控和告警
- 可以通过界面管理备份
- 矿工可以查看自己的数据
- 支持中英文界面

---

## 六、关键需求说明

### 6.1 配置安全验证

**必须验证的关键参数**:

```rust
// 启动时验证
fn validate_critical_config(config: &Config) -> Vec<ConfigWarning> {
    let mut warnings = vec![];

    // 1. ignore_difficulty 检查
    if config.stratum.ignore_difficulty.unwrap_or(false) {
        warnings.push(ConfigWarning {
            level: WarningLevel::Critical,
            param: "ignore_difficulty",
            message: "已禁用难度验证，可能导致不公平收益分配".to_string(),
            recommendation: "设置为 false".to_string(),
        });
    }

    // 2. pplns_ttl_days 检查
    if config.store.pplns_ttl_days < 7 {
        warnings.push(ConfigWarning {
            level: WarningLevel::Critical,
            param: "pplns_ttl_days",
            message: format!("TTL={}天过短，标准为7天", config.store.pplns_ttl_days),
            recommendation: "设置为 7".to_string(),
            impact: "矿工可能损失约 85% 的应得收益".to_string(),
        });
    }

    // 3. donation 检查
    if let Some(donation) = config.stratum.donation {
        if donation > 1000 {
            warnings.push(ConfigWarning {
                level: WarningLevel::Warning,
                param: "donation",
                message: format!("捐赠比例过高: {}%", donation / 100),
                recommendation: "设置为 0-500 (0-5%)".to_string(),
            });
        }
    }

    warnings
}
```

### 6.2 算力计算准确性

**数据来源**:
```
总算力 = Σ(所有Worker的1min平均算力)

Worker算力 = (最近5分钟有效份额 × 网络难度) / 300秒

有效份额 = 通过难度验证的份额
```

### 6.3 收益计算透明化

**展示内容**:
- PPLNS 窗口内的总份额
- 每个矿工的份额占比
- 每个区块的收益分配详情
- Coinbase 交易链接

---

## 七、UI 设计稿

### 7.1 仪表盘线框图

```
┌──────────────────────────────────────────────────────────────────┐
│  DMPool 管理后台                        mainnet | ● 运行中 14d 2h │
│                                                         [配置] [退出] │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 快捷操作                                                      │ │
│  │  [查看日志]  [创建备份]  [重启服务]  [导出数据]              │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ 总算力   │  │ 24h收益  │  │ 在线矿工 │  │ 本月区块 │       │
│  │ 125.5T/s │  │ 0.0125 B │  │  1,234   │  │   156    │       │
│  │  +5.2%   │  │          │  │  +12     │  │          │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  算力趋势 (24小时)                                    [7天] [30天] │ │
│  │  ████████████████████████████████████████████████           │ │
│  │    120 ────────────────────────────────────────────         │ │
│  │    100 ──────────────────────██████████████████████         │ │
│  │     80 ───────────────███████████████████████████████       │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌──────────────────┐  ┌──────────────────────────────────────┐ │
│  │  算力分布 (Top 10) │  │  近期区块                                  │ │
│  │                     │  │  #823456  10分钟前  6.37 BTC           │ │
│  │  ████████ farm01   │  │  #823455  2小时前   6.25 BTC          │ │
│  │  ██████ pool_a     │  │  #823454  5小时前   6.28 BTC          │ │
│  │  ████ pool_b       │  │                                           │ │
│  └──────────────────┘  └──────────────────────────────────────┘ │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

### 7.2 配置页面线框图

```
┌──────────────────────────────────────────────────────────────────┐
│  ⚙️ 配置管理                                          [保存] [重载] │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  ⚠️ 配置状态检查                                              │ │
│  ├─────────────────────────────────────────────────────────────┤ │
│  │  ✅ pplns_ttl_days: 7天 (标准)                              │ │
│  │  ✅ ignore_difficulty: 已启用 (正确)                          │ │
│  │  ✅ donation: 0% (无捐赠)                                    │ │
│  │  ✅ start_difficulty: 32 (合理)                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  [Stratum]    [PPLNS]    [收益]      [安全]      [高级]        │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  Stratum 配置                                              │ │
│  │  ─────────────────────────────────────────────────────────│ │
│  │  端口:         3333     [端口说明]                        │ │
│  │  监听地址:     0.0.0.0  [仅内网建议]                    │ │
│  │  初始难度:     32        [重置]                          │ │
│  │  最低难度:     16        [重置]                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  [💾 保存配置]  [🔄 重载配置]  [📤 导出配置]  [📥 导入配置]      │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## 八、验收标准

### 8.1 功能验收

| 功能 | 验收标准 |
|-----|---------|
| **仪表盘** | - 实时显示总算力、在线矿工、总份额<br>- 算力趋势图表正常<br>- 数据刷新延迟 < 5秒 |
| **配置管理** | - 显示所有配置项<br>- 关键参数有状态指示<br>- 热更新参数立即生效<br>- 警告提示清晰明确 |
| **矿工管理** | - 矿工列表完整准确<br>- 支持搜索和过滤<br>- 可以查看矿工详情<br>- 可以封禁/解封 |
| **区块收益** | - 区块列表完整<br>- 收益分配透明<br>- 可以在浏览器查看交易 |
| **安全性** | - Basic Auth 认证<br>- 敏感操作二次确认<br>- 操作日志记录 |
| **性能** | - 页面加载时间 < 2秒<br>- API 响应时间 < 500ms<br>- 支持并发访问 |

### 8.2 用户体验验收

| 场景 | 操作流程 | 预期结果 |
|-----|---------|---------|
| **查看矿池状态** | 打开首页 → 查看仪表盘 | 5秒内看到完整数据 |
| **调整难度** | 配置 → Stratum → 修改初始难度 → 保存 | 提示保存成功，配置立即生效 |
| **查看矿工** | 矿工列表 → 搜索地址 | 1秒内显示搜索结果 |
| **封禁矿工** | 矿工详情 → 封禁 → 确认 | 提示操作成功，矿工状态更新 |
| **查看收益** | 区块记录 → 点击区块 → 查看分配 | 显示完整收益分配 |

---

## 九、风险与限制

### 9.1 技术风险

| 风险 | 影响 | 缓解措施 |
|-----|------|---------|
| 配置热更新失败 | 服务异常 | 仅允许安全的参数热更新<br>提供回滚机制 |
| 数据库并发读取 | 性能下降 | 使用读写锁<br>缓存热点数据 |
| 静态资源访问 | 无法部署 | 静态文件内嵌到二进制 |

### 9.2 安全风险

| 风险 | 影响 | 缓解措施 |
|-----|------|---------|
| 未授权访问 | 数据泄露 | 强制 Basic Auth<br>IP 白名单 |
| CSRF 攻击 | 恶意操作 | CSRF Token<br>重要操作二次确认 |
| XSS 攻击 | 会话劫持 | 输出转义<br>Content-Security-Policy |

---

## 十、总结

### 10.1 核心价值

1. **透明化**: 矿工可以清楚看到自己的数据和收益分配
2. **可控性**: 管理员可以实时监控和调整矿池参数
3. **安全性**: 关键参数有警告和验证，防止误操作
4. **专业性**: 符合专业矿池的管理需求

### 10.2 开发优先级

```
P0 (必须): 仪表盘、配置查看、警告系统
P1 (重要): 矿工管理、区块查看、日志查看
P2 (增强): 监控面板、备份管理、矿工端
```

### 10.3 下一步

1. ✅ 产品需求文档 (本文档)
2. ⏳ UI 设计稿 (Figma/Sketch)
3. ⏳ API 接口定义
4. ⏳ 前端开发
5. ⏳ 后端开发
6. ⏳ 测试和部署

---

**文档状态**: ✅ 已完成
**下一步**: 开始 UI 设计和 API 开发
