# DMPool Docker Compose 配置
# 基于 DMPool_Decentralized_AI_Solution_v2.md
#
# 网络拓扑:
#   Cloudflare Pages -> Nginx -> Observer API (公开) + Admin API (内部) + Hydrapool + PostgreSQL

version: '3.8'

services:
  # PostgreSQL 数据库 (Hydrapool 使用)
  postgres:
    image: postgres:15-alpine
    container_name: dmpool-postgres
    environment:
      POSTGRES_DB: dmpool
      POSTGRES_USER: dmpool
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me_in_production}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "127.0.0.1:5432:5432"  # 只监听本地
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dmpool"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - dmpool_internal

  # DMPool 主服务 (基于 Hydrapool)
  dmpool:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: dmpool-main
    volumes:
      - ./config.toml:/app/config.toml:ro
      - dmpool_data:/app/data
    ports:
      - "3333:3333"  # Stratum PPLNS
      - "3334:3334"  # Stratum Solo
      - "127.0.0.1:8081:8081"  # Observer API (通过 Nginx 代理)
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      RUST_BACKTRACE: ${RUST_BACKTRACE:-0}
    restart: unless-stopped
    networks:
      - dmpool_internal

  # DMPool Admin (管理后台 - 仅内网访问)
  dmpool-admin:
    build:
      context: .
      dockerfile: docker/Dockerfile.admin
    container_name: dmpool-admin
    volumes:
      - ./config.toml:/app/config.toml:ro
      - admin_data:/app/data
    ports:
      - "127.0.0.1:8080:8080"  # Admin API (通过 Nginx 网络隔离)
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-Admin@2026!}
    restart: unless-stopped
    networks:
      - dmpool_internal

  # Nginx (反向代理 + 网络隔离)
  nginx:
    image: nginx:alpine
    container_name: dmpool-nginx
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx.ssl.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/ssl:/etc/nginx/ssl:ro
      - ./web/dist:/usr/share/nginx/html:ro  # Observer 前端
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - dmpool
      - dmpool-admin
    restart: unless-stopped
    networks:
      - dmpool_internal
      - dmpool_public

volumes:
  postgres_data:
    driver: local
  dmpool_data:
    driver: local
  admin_data:
    driver: local

networks:
  dmpool_internal:
    driver: bridge
    internal: true  # 内部网络，不能直接访问公网
  dmpool_public:
    driver: bridge
